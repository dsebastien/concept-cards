name: Create Release

on:
    workflow_dispatch:
        inputs:
            tag:
                description: 'Tag name (e.g., 1.0.0, 2024-01-15, release-candidate-1)'
                required: true
                type: string

permissions:
    contents: write

jobs:
    pre-release-checks:
        name: Pre-Release Checks
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2

            - name: Install dependencies
              run: bun install

            - name: Run ESLint
              run: bun run lint

            - name: Check formatting
              run: bunx prettier --check .

            - name: TypeScript type checking
              run: bun run tsc

            - name: Validate concepts
              run: bun run validate:quick

            - name: Build project
              run: bun run build:ci

            - name: Summary
              run: |
                  echo "## Pre-Release Checks Passed ✓" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- ✓ ESLint" >> $GITHUB_STEP_SUMMARY
                  echo "- ✓ Prettier formatting" >> $GITHUB_STEP_SUMMARY
                  echo "- ✓ TypeScript type checking" >> $GITHUB_STEP_SUMMARY
                  echo "- ✓ Concept validation" >> $GITHUB_STEP_SUMMARY
                  echo "- ✓ Build" >> $GITHUB_STEP_SUMMARY

    release:
        name: Create Tag and Release
        needs: pre-release-checks
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Install dependencies
              run: bun install

            - name: Update version and changelog
              run: |
                  # Update package.json version
                  bun run release:update-version ${{ inputs.tag }}

                  # Update bun.lock
                  bun install

                  # Generate changelog
                  bun run release:changelog

                  # Commit changes
                  git add package.json bun.lock CHANGELOG.md
                  git commit -m "chore(release): ${{ inputs.tag }}"
                  git push origin HEAD:main

            - name: Create and push tag
              run: |
                  git tag "${{ inputs.tag }}"
                  git push origin "${{ inputs.tag }}"

            - name: Extract changelog for release notes
              id: changelog
              run: |
                  # Extract the latest version section from CHANGELOG.md
                  NOTES=$(awk '/^## \[?[0-9]/{if(p) exit; p=1} p' CHANGELOG.md)
                  # Handle multi-line output
                  echo "notes<<EOF" >> $GITHUB_OUTPUT
                  echo "$NOTES" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ inputs.tag }}
                  name: Release ${{ inputs.tag }}
                  body: ${{ steps.changelog.outputs.notes }}
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
